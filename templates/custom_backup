#!/bin/bash
# This file is generated by Ansible. Don't change it; it will change
# itself back to what it was.
{# The comment above is of course for the file deployed, not for this
template, which you can change. #}
read -r -d '' USAGE <<EOF1
This script is a wrapper around duplicity, with options concerning the
backup of this specific machine.

custom_backup help
custom_backup scheduled
custom_backup restore [options] target
custom_backup verify [options] target
custom_backup collection-status [options]
custom_backup list-current-files [options]
custom_backup cleanup [options]

"help" shows this message. "scheduled" is intended to be run by cron
and performs the scheduled backup. The rest of the commands are
identical to the equivalent duplicity commands; the only difference is
that several options, such as the backup location, gpg options, and so
on, are passed to duplicity anyway and therefore you don't need to
specify them.
EOF1

set -e

PATH=/bin:/usr/bin:/sbin:/usr/sbin
export PASSPHRASE=''  # We use gpg with unencrypted private key
TARGET={{ duplicity_target }}
VERBOSITY={{ duplicity_verbosity }}
GPG_OPTIONS="--encrypt-key={{ get_gpg_key_fingerprint.stdout[-8:] }}"
EXTRA_PARMS="{{ duplicity_extra_parms.replace('"', '\\"') }}"
{% for key, value in duplicity_environment.iteritems() -%}
  export {{ key }}="{{ value }}"
{% endfor %}

includes_excludes=""
for f in /etc/duplicity/includes_excludes/*; do
    includes_excludes="${includes_excludes} `cat $f`"
done

all_options="$GPG_OPTIONS --verbosity=$VERBOSITY \
            --archive-dir=/var/cache/duplicity $EXTRA_PARMS"

perform_scheduled_backup() {
    # Pre scripts
    cd / # Pre/post scripts may contain "su postgres ...", which shows an error
         # message if run in directory /root, because it is inaccessible by postgres
    for script in /etc/duplicity/pre/*; do
        if [ -x $script ]; then
            $script
        fi
    done

    duplicity remove-older-than {{ duplicity_remove_older_than }} --force $all_options $TARGET
{% if duplicity_remove_all_inc_of_but_n_full %}
    # For the following command we add --verbosity=error at the end,
    # which overrides whatever verbosity has been set; this is because
    # with "warning", on some machines it shows a "No extraneous files
    # found, nothing deleted in cleanup", which is harmless and not
    # clear why it appears.
    duplicity remove-all-inc-of-but-n-full {{ duplicity_remove_all_inc_of_but_n_full }} --force $all_options \
              --verbosity=error $TARGET
{% endif %}
    duplicity --full-if-older-than={{ duplicity_full_if_older_than }} $includes_excludes \
              $all_options --no-print-statistics / $TARGET

    # Post scripts
    for script in /etc/duplicity/post/*; do
        if [ -x $script ]; then
            $script
        fi
    done
}

command=$1
shift
case "$command" in
    help)
        echo "$USAGE"
        ;;
    restore|verify)
        duplicity $command $all_options $TARGET $*
        ;;
    collection-status|list-current-files|cleanup)
        duplicity $command $all_options $* $TARGET
        ;;
    scheduled)
        perform_scheduled_backup
        ;;
    *)
        echo "$USAGE" >&2
        exit 1
        ;;
esac
